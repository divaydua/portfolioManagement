<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portfolio Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="/js/app.js"></script>
  </head>
  <body class="bg-slate-50">
    <nav class="bg-white border-b border-slate-200">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2 text-xl font-semibold">ðŸ“ˆ Dashboard</div>
        <a href="/index.html" class="text-sm text-slate-600 hover:text-slate-900">Home</a>
      </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <div class="flex items-center gap-3 mb-6">
        <h1 class="text-2xl font-bold text-slate-900">Your Portfolio</h1>
        <span id="who" class="text-slate-600"></span>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">Holdings</h2>
              <button id="refresh" class="px-3 py-1.5 rounded border border-slate-300 text-slate-800 hover:bg-white/50">Refresh</button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-slate-500">
                    <th class="py-2">Symbol</th>
                    <th class="py-2">Quantity</th>
                    <th class="py-2">Buy Price</th>
                  </tr>
                </thead>
                <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div>
          <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
            <h2 class="font-semibold mb-2">Buy</h2>
            <label class="text-sm text-slate-600">Symbol</label>
            <input id="symbol" class="mt-1 w-full rounded border border-slate-300 px-3 py-2" placeholder="AAPL">
            <label class="text-sm text-slate-600 mt-3 block">Quantity</label>
            <input id="qty" type="number" step="0.0001" class="mt-1 w-full rounded border border-slate-300 px-3 py-2">
            <label class="text-sm text-slate-600 mt-3 block">Buy Price</label>
            <input id="price" type="number" step="0.01" class="mt-1 w-full rounded border border-slate-300 px-3 py-2">
            <button id="buy" class="mt-4 w-full px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Add Holding</button>
            <pre id="buyResult" class="mt-3 text-xs text-slate-600"></pre>
          </div>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
      const { api, state, toast } = window.App || {};
      if (!api) { console.error('App helpers not loaded'); return; }
      const q = new URLSearchParams(location.search);
      const username = q.get('username') || state.username || '';
      document.getElementById('who').textContent = username ? `(Logged in as ${username})` : '(Not logged in)';

      async function loadHoldings() {
        if (!username) { toast('Please login first', 'error'); return; }
        const res = await api(`/portfolio?username=${encodeURIComponent(username)}`);
        const data = Array.isArray(res.data) ? res.data : [];
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        data.forEach(h => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-slate-50';
          tr.innerHTML = `<td class="py-2">${(h.asset && h.asset.symbol) || ''}</td><td class="py-2">${h.quantity}</td><td class="py-2">${h.buyPrice}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('refresh').onclick = loadHoldings;
      document.getElementById('buy').onclick = async () => {
        if (!username) { toast('Please login first', 'error'); return; }
        const body = JSON.stringify({
          symbol: document.getElementById('symbol').value,
          quantity: Number(document.getElementById('qty').value),
          buyPrice: Number(document.getElementById('price').value)
        });
        const res = await api(`/portfolio/add?username=${encodeURIComponent(username)}`, { method: 'POST', body });
        if (res.ok) { toast('Added holding', 'success'); }
        document.getElementById('buyResult').textContent = typeof res.data === 'string' ? res.data : JSON.stringify(res.data, null, 2);
        await loadHoldings();
      };

      loadHoldings();
      });
    </script>
  </body>
  </html>


